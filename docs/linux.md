# Linux

In order to support the underlying Ubuntu install for WSL, the following strategies have been established for maintaining the underlying software in a disconnected environment. This required software can be retrieved and installed via the [Build-LinuxCache.ps1](./scripts/Build-LinuxCache.md) script.

## Install Apt Software

Open WSL and change to the `bundle/linux` cache directory.

```bash
sudo apt dpkg -i ./apt-cache/*.deb
```

You can verify the installation by checking for the presence of the commands generated by the installations:

```bash
commands="apt-offline node npm git az jq uuidgen"
echo "$(comamnd -v ${commands})"

# sample output:
# /usr/bin/apt-offline
# /usr/bin/node
# /mnt/c/Program Files/nodejs/npm
# /usr/bin/git
# /usr/bin/az
# /usr/bin/jq
# /usr/bin/uuidgen
```

## Install the .NET SDK

Open WSL and change to the `bundle/linux/dotnet/` cache directory.

```bash
# replace <version> and <arch> with the proper values
DOTNET_FILE=dotnet-sdk-<version>-linux-<arch>.tar.gz

export DOTNET_ROOT=~/.dotnet/

mkdir -p "$DOTNET_ROOT" && tar zxf "$DOTNET_FILE" -C "$DOTNET_ROOT"

export PATH=$PATH:$DOTNET_ROOT:$DOTNET_ROOT/tools
```

You can verify the installation with `dotnet --list-sdks`.

## apt-offline Updates

To update and upgrade the underlying system, the [apt-offline](https://manpages.ubuntu.com/manpages/jammy/man8/apt-offline.8.html) apt package is used. You must be sure it is installed by following the [Install Apt Software](#install-apt-software) steps above.

First, a signature file (`offline.sig`) containing the update / upgrade information needs to be generated on the offline system:

```bash
sudo apt-offline set ./offline.sig --update --upgrade
```

Transfer the `offline.sig` file to an internet-facing workstation and execute:

> This step took an unreasonably long amount of time to complete. Looking into writing a script that iterates through the `.sig` file to download the updates vs. using `apt-offline` in WSL. See [apt-offline: Script Package Downloads from Generated .sig Files](https://github.com/JaimeStill/azure-dev-resources/issues/15).

```bash
sudo apt-offline get -d ./update ./offline-sig
```

Once complete, transfer the generated `update` directory to the offline system and execute:

```bash
sudo apt-offline install ./update
```

## Building the Cache

The PowerShell script [Build-LinuxCache.ps1](./scripts/Build-LinuxCache.md) defines the ability to generate an APT cache, as well as retrieve the latest version of a specified .NET SDK. The desired APT packages are specified in a [JSON file](./scripts/Build-LinuxCache.md#linuxjson) that is provided to the script. The PowerShell script configures the execution of a [cache-packages.bash](./scripts/Build-LinuxCache.md#cache-packagesbash) script that is executed via `wsl --exec` to achieve this functionality. The generated cache can then be transported to a disconnected network and used to establish or update a WSL Ubuntu system.

Parameter | Type | Default Value | Description
----------|------|---------------|------------
Target | **string** | `../linux` | The cache target directory.
Source | **string** | `./data/linux.json` | The JSON file containing the list of apt packages to cache.
Platform | **string** | `linux` | The .NET SDK OS target.
Arch | **string** | `x64` | The .NET SDK system architecture target.
Channel | **string** | `STS` | The .NET SDK channel. Valid options are STS, LTS, or X.X (i.e. 3.1, 5.0, 8.0).
DotnetTarget | **string** | `../linux/dotnet` | The .NET SDK cache target directory.
Extract | **switch** | `null` | When provided, extracts the downloaded `.tar.gz` for the .NET SDK into `$DotnetTarget/.dotnet/`